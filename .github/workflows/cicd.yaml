  deploy-to-self-hosted:
    name: Deploy to self-hosted runner (PowerEdge)
    needs: pull-and-smoke
    runs-on: [self-hosted, linux, x64]

    # On the host we want MLflow to use the host path (absolute)
    env:
      MLFLOW_TRACKING_URI: "file:///home/sweta/mtp/data/mlruns"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Print runner info (labels & name)
        run: |
          echo "GitHub runner labels: ${{ toJson(github.runner.labels) }}"
          echo "Runner name: ${{ github.runner.name || 'unknown' }}"

      - name: Debug runner user & path ownership
        run: |
          echo "Runner user: $(id -un) (UID=$(id -u))"
          echo "Runner groups: $(id -Gn)"
          stat -c '%U %G %A %n' /home/sweta /home/sweta/mtp 2>/dev/null || true
          ls -ld /home/sweta/mtp/data 2>/dev/null || echo "/home/sweta/mtp/data not present"

      - name: Check required secrets are present
        run: |
          if [ -z "${{ secrets.DOCKERHUB_USERNAME }}" ] || [ -z "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
            echo "::error::Required DockerHub secrets not present. Failing deploy."
            exit 1
          fi
          echo "Required secrets present."

      - name: Ensure docker is present on self-hosted node
        run: |
          set -euo pipefail
          if ! command -v docker >/dev/null 2>&1; then
            echo "ERROR: docker not found on self-hosted runner"; exit 1
          fi
          echo "Docker present: $(docker --version)"

      - name: Prepare host path & cleanup previous container
        run: |
          set -euo pipefail
          mkdir -p /home/sweta/mtp/data
          docker rm -f mtp_root 2>/dev/null || true

      - name: Ensure host data dir exists and is writable (no sudo)
        run: |
          set -euo pipefail
          TARGET_DIR=/home/sweta/mtp/data
          echo "Checking ${TARGET_DIR} (non-sudo attempt)..."

          # Try to create the directory as the current runner user
          mkdir -p "${TARGET_DIR}" || true

          # Try to write a temp file to test writability
          TMPFILE="${TARGET_DIR}/.ci_write_test_$RANDOM"
          if ! printf "ok" > "${TMPFILE}" 2>/dev/null; then
            echo "::error::${TARGET_DIR} is NOT writable by $(id -un)."
            echo "Runner user needs write access and permission to run docker without sudo."
            echo
            echo "Please run the following ONCE on the self-hosted host as an administrator:"
            echo "  sudo mkdir -p ${TARGET_DIR}"
            echo "  sudo chown -R $(id -un):$(id -gn) ${TARGET_DIR}"
            echo "  sudo chmod -R 775 ${TARGET_DIR}"
            echo
            echo "Also ensure the runner user is in the 'docker' group so docker commands do not need sudo:"
            echo "  sudo usermod -aG docker $(id -un)"
            echo
            echo "After applying the above, re-run this workflow."
            exit 1
          else
            # cleanup tmp file
            rm -f "${TMPFILE}"
            echo "${TARGET_DIR} is writable by $(id -un)."
          fi

          # Ensure docker is available to runner user (no sudo)
          if ! command -v docker >/dev/null 2>&1; then
            echo "::error::docker CLI is not installed on the host or not in PATH for runner user."
            exit 1
          fi

          # Check the runner user can run docker ps (no sudo)
          if ! docker ps -q >/dev/null 2>&1; then
            echo "::warning::Runner user cannot run 'docker ps' without sudo. Ensure runner user is in docker group."
            echo "You can check group membership with: id -nG $(id -un)"
            exit 1
          fi

          echo "Host data dir and docker CLI checks passed (non-sudo)."

      - name: Run repo scripts on self-hosted runner BEFORE container
        run: |
          set -euo pipefail
          SCRIPTS_DIR="${{ github.workspace }}/scripts"
          HOST_DATA_DIR="/home/sweta/mtp/data"
          mkdir -p "${HOST_DATA_DIR}"
          echo "Running scripts from ${SCRIPTS_DIR} targeting ${HOST_DATA_DIR}"
          if [ ! -d "${SCRIPTS_DIR}" ]; then
            echo "No scripts/ directory found in repo; skipping host script-run step."
            exit 0
          fi
          chmod -R +x "${SCRIPTS_DIR}" || true

          run_one() {
            name="$1"
            cmd="$2"
            echo "=== RUN ${name} (host) ==="
            if [ ! -f "${cmd}" ]; then
              echo "WARN: ${cmd} not found; skipping ${name}"
              return 0
            fi
            HOST_DATA_DIR="${HOST_DATA_DIR}" DATA_DIR="${HOST_DATA_DIR}" ${cmd}
            rc=$?
            if [ $rc -eq 0 ]; then
              echo "${name} ok at $(date -u)" > "${HOST_DATA_DIR}/.${name}_done"
              echo "=== ${name} SUCCEEDED ==="
            else
              echo "${name} FAILED at $(date -u)" > "${HOST_DATA_DIR}/.${name}_failed"
              echo "=== ${name} FAILED ===" >&2
              exit $rc
            fi
          }

          run_one "ingestion"  "${SCRIPTS_DIR}/ingestion.sh"
          run_one "preprocess" "${SCRIPTS_DIR}/preprocess.sh"
          run_one "model"      "${SCRIPTS_DIR}/model.sh"
          run_one "app"        "${SCRIPTS_DIR}/app.sh"

          echo "Host script-run finished. Marker files in ${HOST_DATA_DIR}:"
          ls -la "${HOST_DATA_DIR}" | sed -n '1,200p' || true

      - name: Sync mlruns to host data dir (deploy)
        run: |
          set -euo pipefail
          SRC="${{ github.workspace }}/data/mlruns"
          DST="/home/sweta/mtp/data/mlruns"
          echo "Syncing ${SRC} -> ${DST}"

          if [ ! -d "${SRC}" ]; then
            echo "No mlruns in workspace (${SRC}) — skipping sync."
            exit 0
          fi

          mkdir -p "${DST}"
          chmod -R u+rwX,g+rwX,o+rX "$(dirname "${DST}")" || true

          rsync -rlptD --no-owner --no-group --chmod=Du=rwx,Dgo=rx,Fu=rw,Fgo=r --delete "${SRC}/" "${DST}/" || true

          echo "Attempting to chown ${DST} to uid 1000:1000 (if permitted)..."
          chown -R 1000:1000 /home/sweta/mtp/data 2>/dev/null || echo "chown not permitted by current user — continuing"

          chmod -R u+rwX /home/sweta/mtp/data || true
          echo "Sync step finished."

      - name: Log in to DockerHub on target
        run: |
          set -euo pipefail
          docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" -p "${{ secrets.DOCKERHUB_TOKEN }}"

      - name: Cleanup any existing container named mtp_root (no sudo)
        run: |
          set -euo pipefail
          echo "Attempting to remove any existing container named mtp_root (non-sudo)..."
          if docker ps -a --format '{{.Names}}' | grep -q '^mtp_root$'; then
            docker rm -f mtp_root || echo "Failed to remove mtp_root (check runner docker permissions)"
          else
            echo "No existing mtp_root container found."
          fi

      - name: Pull image on target (fail if not available) and start container (root mode)
        run: |
          set -euo pipefail
          if [ "${{ github.event.inputs.image_ref }}" != "" ]; then
            IMAGE_TO_DEPLOY="${{ github.event.inputs.image_ref }}"
          else
            IMAGE_TO_DEPLOY="${{ env.IMAGE_REF }}"
          fi
          echo "Pulling image ${IMAGE_TO_DEPLOY}"
          docker pull "${IMAGE_TO_DEPLOY}"

          echo "Starting container mtp_root from ${IMAGE_TO_DEPLOY} (running as root inside container)"
          docker run -d --name mtp_root \
            -e SKIP_TRAIN=0 \
            -e MLFLOW_PORT=5051 \
            -e MLFLOW_START_TIMEOUT=120 \
            -p 5051:5051 -p 8080:8080 \
            -v /home/sweta/mtp/data:/app/data \
            -v "${{ github.workspace }}/scripts":/app/scripts \
            "${IMAGE_TO_DEPLOY}"

      - name: Wait & verify endpoints on self-hosted
        run: |
          set -euo pipefail
          for i in $(seq 1 30); do
            code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/ || echo "000")
            echo "FastAPI attempt $i -> $code"
            if [ "$code" = "200" ] || [ "$code" = "302" ]; then break; fi
            sleep 2
          done
          for i in $(seq 1 30); do
            code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5051/ || echo "000")
            echo "MLflow attempt $i -> $code"
            if [ "$code" = "200" ]; then break; fi
            sleep 2
          done
          echo "Final checks:"
          curl -s -o /dev/null -w "fastapi:%{http_code}\n" http://localhost:8080/ || true
          curl -s -o /dev/null -w "mlflow:%{http_code}\n" http://localhost:5051/ || true

      - name: Tail logs
        run: docker logs --tail 200 mtp_root || true
