name: CI/CD - MTP Pull & Deploy (smoke test + deploy)

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      image_ref:
        description: 'Image reference to pull (overrides default IMAGE_REF)'
        required: false
        default: ''

env:
  IMAGE_REF: sumitdoh/mtp:latest
  IMAGE_NAME: sumitdoh/mtp

jobs:
  pull-and-smoke:
    name: Pull image, run smoke test
    runs-on: ubuntu-latest

    # Make mlflow write to workspace/data/mlruns on this runner
    env:
      MLFLOW_TRACKING_URI: "file:${{ github.workspace }}/data/mlruns"   # <<< CHANGED

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare workspace data dir
        run: |
          set -euo pipefail
          mkdir -p "${{ github.workspace }}/data"
          ls -la "${{ github.workspace }}" || true

      - name: Run repo scripts (ingestion, preprocess, model, app) on the runner BEFORE container
        run: |
          set -euo pipefail
          SCRIPTS_DIR="${{ github.workspace }}/scripts"
          DATA_DIR="${{ github.workspace }}/data"
          mkdir -p "${DATA_DIR}"
          echo "Looking for scripts in ${SCRIPTS_DIR}"
          if [ ! -d "${SCRIPTS_DIR}" ]; then
            echo "No scripts/ directory found in repo; skipping script-run step."
            exit 0
          fi
          chmod -R +x "${SCRIPTS_DIR}" || true

          run_one() {
            name="$1"
            cmd="$2"
            echo "=== RUN ${name} ==="
            if [ ! -f "${cmd}" ]; then
              echo "WARN: ${cmd} not found; skipping ${name}"
              return 0
            fi
            # ensure any scripts that use $DATA_DIR will see it
            DATA_DIR="${DATA_DIR}" "${cmd}"
            if [ $? -eq 0 ]; then
              echo "${name} ok at $(date -u)" > "${DATA_DIR}/.${name}_done"
              echo "=== ${name} SUCCEEDED ==="
            else
              echo "${name} FAILED at $(date -u)" > "${DATA_DIR}/.${name}_failed"
              echo "=== ${name} FAILED ===" >&2
              tail -n 200 "${DATA_DIR}"/* || true
              exit 1
            fi
          }

          run_one "ingestion"  "${SCRIPTS_DIR}/ingestion.sh"
          run_one "preprocess" "${SCRIPTS_DIR}/preprocess.sh"
          run_one "model"      "${SCRIPTS_DIR}/model.sh"
          run_one "app"        "${SCRIPTS_DIR}/app.sh"

          echo "Script-run finished. Marker files in ${DATA_DIR}:"
          ls -la "${DATA_DIR}" | sed -n '1,200p' || true

      - name: Log in to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull image (manual upload expected) and fail if missing
        run: |
          set -euo pipefail
          if [ "${{ github.event.inputs.image_ref }}" != "" ]; then
            IMAGE_TO_PULL="${{ github.event.inputs.image_ref }}"
          else
            IMAGE_TO_PULL="${{ env.IMAGE_REF }}"
          fi
          echo "Pulling image ${IMAGE_TO_PULL}"
          docker pull "${IMAGE_TO_PULL}"
          echo "Pulled ${IMAGE_TO_PULL} successfully"

      - name: Run ephemeral container for quick smoke test (MLflow on 5051)
        run: |
          set -euo pipefail
          if [ "${{ github.event.inputs.image_ref }}" != "" ]; then
            IMAGE_TO_RUN="${{ github.event.inputs.image_ref }}"
          else
            IMAGE_TO_RUN="${{ env.IMAGE_REF }}"
          fi
          docker rm -f cicd_mtp_test 2>/dev/null || true
          docker run -d --name cicd_mtp_test \
            -e CHOWN_ON_START=1 \
            -e DROP_TO_USER=1 \
            -e SKIP_TRAIN=1 \
            -e MLFLOW_PORT=5051 \
            -e MLFLOW_START_TIMEOUT=60 \
            -p 5051:5051 -p 8080:8080 \
            -v "${{ github.workspace }}/data":/app/data \
            -v "${{ github.workspace }}/scripts":/app/scripts \
            "${IMAGE_TO_RUN}"

      - name: Wait for FastAPI and MLflow to be healthy (retries)
        run: |
          set -euo pipefail
          for i in $(seq 1 30); do
            code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/ || echo "000")
            echo "FastAPI attempt $i -> ${code}"
            if [ "$code" = "200" ] || [ "$code" = "302" ]; then break; fi
            sleep 2
          done
          for i in $(seq 1 30); do
            code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5051/ || echo "000")
            echo "MLflow attempt $i -> ${code}"
            if [ "$code" = "200" ]; then break; fi
            sleep 2
          done
          echo "Final checks:"
          curl -s -o /dev/null -w "fastapi:%{http_code}\n" http://localhost:8080/ || true
          curl -s -o /dev/null -w "mlflow:%{http_code}\n" http://localhost:5051/ || true

      - name: Collect logs (last 200 lines) and cleanup
        run: |
          docker logs --tail 200 cicd_mtp_test || true
          docker rm -f cicd_mtp_test || true

  deploy-to-self-hosted:
    name: Deploy to self-hosted runner (PowerEdge)
    needs: pull-and-smoke
    runs-on: [self-hosted, linux, x64]

    # On the host we want MLflow to use the host path
    env:
      # this ensures any scripts run on the host that rely on MLFLOW_TRACKING_URI write to host path
      MLFLOW_TRACKING_URI: "file:/home/sweta/mtp/data/mlruns"   # <<< CHANGED

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Print runner info (labels & name)
        run: |
          echo "GitHub runner labels: ${{ toJson(github.runner.labels) }}"
          echo "Runner name: ${{ github.runner.name || 'unknown' }}"

      - name: Check required secrets are present
        run: |
          if [ -z "${{ secrets.DOCKERHUB_USERNAME }}" ] || [ -z "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
            echo "::error::Required DockerHub secrets not present. Failing deploy."
            exit 1
          fi
          echo "Required secrets present."

      - name: Ensure docker is present on self-hosted node
        run: |
          set -euo pipefail
          if ! command -v docker >/dev/null 2>&1; then
            echo "ERROR: docker not found on self-hosted runner"; exit 1
          fi
          echo "Docker present: $(docker --version)"

      - name: Prepare host path & cleanup previous container
        run: |
          set -euo pipefail
          mkdir -p /home/sweta/mtp/data
          docker rm -f mtp_root 2>/dev/null || true

      - name: Run repo scripts on self-hosted runner BEFORE container
        run: |
          set -euo pipefail
          SCRIPTS_DIR="${{ github.workspace }}/scripts"
          HOST_DATA_DIR="/home/sweta/mtp/data"
          mkdir -p "${HOST_DATA_DIR}"
          echo "Running scripts from ${SCRIPTS_DIR} targeting ${HOST_DATA_DIR}"
          if [ ! -d "${SCRIPTS_DIR}" ]; then
            echo "No scripts/ directory found in repo; skipping host script-run step."
            exit 0
          fi
          chmod -R +x "${SCRIPTS_DIR}" || true

          run_one() {
            name="$1"
            cmd="$2"
            echo "=== RUN ${name} (host) ==="
            if [ ! -f "${cmd}" ]; then
              echo "WARN: ${cmd} not found; skipping ${name}"
              return 0
            fi
            # export HOST_DATA_DIR so scripts can read it
            HOST_DATA_DIR="${HOST_DATA_DIR}" DATA_DIR="${HOST_DATA_DIR}" ${cmd}
            rc=$?
            if [ $rc -eq 0 ]; then
              echo "${name} ok at $(date -u)" > "${HOST_DATA_DIR}/.${name}_done"
              echo "=== ${name} SUCCEEDED ==="
            else
              echo "${name} FAILED at $(date -u)" > "${HOST_DATA_DIR}/.${name}_failed"
              echo "=== ${name} FAILED ===" >&2
              exit $rc
            fi
          }

          run_one "ingestion"  "${SCRIPTS_DIR}/ingestion.sh"
          run_one "preprocess" "${SCRIPTS_DIR}/preprocess.sh"
          run_one "model"      "${SCRIPTS_DIR}/model.sh"
          run_one "app"        "${SCRIPTS_DIR}/app.sh"

          echo "Host script-run finished. Marker files in ${HOST_DATA_DIR}:"
          ls -la "${HOST_DATA_DIR}" | sed -n '1,200p' || true

      - name: Sync mlruns to host data dir (deploy)
        run: |
          set -euo pipefail
          SRC="${{ github.workspace }}/data/mlruns"
          DST="/home/sweta/mtp/data/mlruns"
          echo "Syncing ${SRC} -> ${DST}"

          # If CI didn't produce mlruns, skip (don't fail deploy)
          if [ ! -d "${SRC}" ]; then
            echo "No mlruns in workspace (${SRC}) — skipping sync."
            exit 0
          fi

          # Ensure destination exists and has permissive permissions
          mkdir -p "${DST}"
          chmod -R u+rwX,g+rwX,o+rX "$(dirname "${DST}")" || true

          # Use rsync but do NOT attempt to change owner/group (avoids chown/chgrp errors)
          rsync -rlptD --no-owner --no-group --chmod=Du=rwx,Dgo=rx,Fu=rw,Fgo=r --delete "${SRC}/" "${DST}/" || true

          # If chown is needed (container's mlflow runs as uid 1000), try to set it.
          echo "Attempting to chown ${DST} to uid 1000:1000 (if permitted)..."
          chown -R 1000:1000 /home/sweta/mtp/data 2>/dev/null || echo "chown not permitted by current user — continuing"

          # Ensure basic permissions for readability
          chmod -R u+rwX /home/sweta/mtp/data || true

          echo "Sync step finished."

      - name: Log in to DockerHub on target
        run: |
          set -euo pipefail
          docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" -p "${{ secrets.DOCKERHUB_TOKEN }}"

      - name: Pull image on target (fail if not available) and start container
        run: |
          set -euo pipefail
          if [ "${{ github.event.inputs.image_ref }}" != "" ]; then
            IMAGE_TO_DEPLOY="${{ github.event.inputs.image_ref }}"
          else
            IMAGE_TO_DEPLOY="${{ env.IMAGE_REF }}"
          fi
          echo "Pulling image ${IMAGE_TO_DEPLOY}"
          docker pull "${IMAGE_TO_DEPLOY}"

          echo "Starting container mtp_root from ${IMAGE_TO_DEPLOY}"
          docker run -d --name mtp_root \
            -e CHOWN_ON_START=1 \
            -e DROP_TO_USER=1 \
            -e SKIP_TRAIN=0 \
            -e MLFLOW_PORT=5051 \
            -e MLFLOW_START_TIMEOUT=120 \
            -p 5051:5051 -p 8080:8080 \
            -v /home/sweta/mtp/data:/app/data \
            -v "${{ github.workspace }}/scripts":/app/scripts \
            "${IMAGE_TO_DEPLOY}"

      - name: Wait & verify endpoints on self-hosted
        run: |
          set -euo pipefail
          for i in $(seq 1 30); do
            code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/ || echo "000")
            echo "FastAPI attempt $i -> $code"
            if [ "$code" = "200" ] || [ "$code" = "302" ]; then break; fi
            sleep 2
          done
          for i in $(seq 1 30); do
            code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5051/ || echo "000")
            echo "MLflow attempt $i -> $code"
            if [ "$code" = "200" ]; then break; fi
            sleep 2
          done
          echo "Final checks:"
          curl -s -o /dev/null -w "fastapi:%{http_code}\n" http://localhost:8080/ || true
          curl -s -o /dev/null -w "mlflow:%{http_code}\n" http://localhost:5051/ || true

      - name: Tail logs
        run: docker logs --tail 200 mtp_root || true
