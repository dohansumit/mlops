name: CI/CD - MTP Pull & Deploy (smoke test + deploy)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  # Set IMAGE_REF to the image you upload manually (default uses latest)
  IMAGE_REF: myorg/mtp:latest
  IMAGE_NAME: myorg/mtp

jobs:
  pull-and-smoke:
    name: Pull image, run smoke test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull image (manual upload expected)
        run: |
          echo "Pulling image $IMAGE_REF"
          docker pull $IMAGE_REF

      - name: Run ephemeral container for quick smoke test (MLflow on 5051)
        run: |
          docker rm -f cicd_mtp_test 2>/dev/null || true
          docker run -d --name cicd_mtp_test \
            -e CHOWN_ON_START=1 \
            -e DROP_TO_USER=1 \
            -e SKIP_TRAIN=1 \
            -e MLFLOW_PORT=5051 \
            -e MLFLOW_START_TIMEOUT=60 \
            -p 5051:5051 -p 8080:8080 \
            -v ${{ github.workspace }}/data:/app/data \
            $IMAGE_REF

      - name: Wait for services
        run: |
          # wait for up to 60s for FastAPI to respond
          for i in {1..30}; do
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/ | grep -q "200"; then
              echo "FastAPI is up"; break
            fi
            sleep 2
          done
          echo "MLflow (5051) HTTP check:"
          curl -s -o /dev/null -w "%{http_code}\n" http://localhost:5051/ || true
          echo "FastAPI (8080) HTTP check:"
          curl -s -o /dev/null -w "%{http_code}\n" http://localhost:8080/ || true

      - name: Collect logs (last 200 lines) and cleanup
        run: |
          docker logs --tail 200 cicd_mtp_test || true
          docker rm -f cicd_mtp_test || true

  deploy-to-self-hosted:
    name: Deploy to self-hosted runner (PowerEdge)
    needs: pull-and-smoke
    if: env.SELF_HOSTED_LABEL != '' && secrets.DOCKERHUB_TOKEN != ''
    runs-on: ${{ secrets.SELF_HOSTED_LABEL }}

    steps:
      - name: Log in to DockerHub on target
        run: |
          docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull image on target
        run: |
          docker pull ${{ env.IMAGE_REF }}

      - name: Stop & remove old container (if present)
        run: |
          docker rm -f mtp_root 2>/dev/null || true

      - name: Start new container (MLflow on host 5051)
        run: |
          docker run -d --name mtp_root \
            -e CHOWN_ON_START=1 \
            -e DROP_TO_USER=1 \
            -e SKIP_TRAIN=0 \
            -e MLFLOW_PORT=5051 \
            -e MLFLOW_START_TIMEOUT=120 \
            -p 5051:5051 -p 8080:8080 \
            -v /home/sweta/mtp/data:/app/data \
            ${{ env.IMAGE_REF }}

      - name: Wait & verify endpoints
        run: |
          sleep 8
          echo "FastAPI status:"
          curl -s -o /dev/null -w "%{http_code}\n" http://localhost:8080 || true
          echo "MLflow status:"
          curl -s -o /dev/null -w "%{http_code}\n" http://localhost:5051 || true

      - name: Tail logs
        run: docker logs --tail 200 mtp_root || true
